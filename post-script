#!/usr/bin/env bash
set -euo pipefail

# ─── 1) System packages ───────────────────────────────────────────────────────
sudo pacman -Syu --needed \
  base-devel git \
  obsidian swww waybar coreutils python-pipx rofi exa zoxide fzf

# ─── 2) pipx & Exegol ─────────────────────────────────────────────────────────
pipx ensurepath # make sure ~/.local/bin is on your PATH
pipx install exegol

# ─── 3) Install or update yay (AUR helper) ────────────────────────────────────
YAY_DIR="/tmp/yay"
if [[ -d "$YAY_DIR" ]]; then
  echo "Updating existing yay in $YAY_DIR"
  cd "$YAY_DIR"
  git pull --ff-only
else
  echo "Cloning yay into $YAY_DIR"
  git clone https://aur.archlinux.org/yay.git "$YAY_DIR"
  cd "$YAY_DIR"
fi
makepkg -si --noconfirm

# ─── 4) AUR packages ──────────────────────────────────────────────────────────
yay -S --noconfirm min-browser zsh bat

# ─── 5) Ensure Zsh is a valid shell and change shell ──────────────────────────
ZSH_PATH="$(which zsh)"
if ! grep -Fxq "$ZSH_PATH" /etc/shells; then
  echo "Adding $ZSH_PATH to /etc/shells"
  echo "$ZSH_PATH" | sudo tee -a /etc/shells
fi
sudo chsh -s "$ZSH_PATH" "$USER"

# ─── 6) fzf integration ───────────────────────────────────────────────────────
if [[ ! -d "${HOME}/.fzf" ]]; then
  git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
  yes | ~/.fzf/install --all
fi

# ─── 7) Oh My Zsh (non-interactive) and custom plugins ───────────────────────
export RUNZSH=no # don’t spawn a new shell after install
export CHSH=no   # we handle shell change explicitly
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
# zsh-autosuggestions
if [[ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]]; then
  git clone https://github.com/zsh-users/zsh-autosuggestions.git "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
fi
# zsh-syntax-highlighting
if [[ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]]; then
  git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
fi
# fzf-tab
if [[ ! -d "$ZSH_CUSTOM/plugins/fzf-tab" ]]; then
  git clone https://github.com/Aloxaf/fzf-tab.git "$ZSH_CUSTOM/plugins/fzf-tab"
fi
# enable the plugins in .zshrc
sed -i 's/^plugins=(/plugins=(zsh-autosuggestions zsh-syntax-highlighting fzf-tab /' ~/.zshrc

# ─── 8) Dotfiles bootstrap ────────────────────────────────────────────────────
cd ~/.dotfiles
./install
