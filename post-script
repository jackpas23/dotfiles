#!/usr/bin/env bash
set -euo pipefail

# ─── 0) Identify current user/home ───────────────────────────────────────────
USER_HOME="$HOME"
echo "→ Setting up tools in: $USER_HOME"

# ─── 1) System packages (install these yourself) ─────────────────────────────
echo
echo "!!! Please install system packages before running this script: !!!"
echo "  sudo pacman -Syu --needed base-devel git obsidian swww waybar coreutils python-pipx rofi exa zoxide fzf fastfetch"
echo "  (and later: yay -S --noconfirm min-browser zsh bat)"
echo

# ─── 2) pipx & Exegol ─────────────────────────────────────────────────────────
export PATH="$USER_HOME/.local/bin:$PATH"
if ! command -v pipx &>/dev/null; then
  echo "Error: pipx not found in PATH. Install python-pipx and re-run." >&2
  exit 1
fi
echo "→ Ensuring pipx is on your PATH"
pipx ensurepath
echo "→ Installing/upgrading Exegol"
pipx install --force exegol

# ─── 3) Clone or update yay (AUR helper) ──────────────────────────────────────
YAY_DIR="$USER_HOME/tmp/yay"
mkdir -p "${YAY_DIR%/*}"
if [[ -d "$YAY_DIR/.git" ]]; then
  echo "→ Updating existing yay repo"
  git -C "$YAY_DIR" pull --ff-only
else
  echo "→ Cloning yay into $YAY_DIR"
  rm -rf "$YAY_DIR"
  git clone https://aur.archlinux.org/yay.git "$YAY_DIR"
fi

# build & install yay (this will prompt for your password when installing)
echo "→ Building and installing yay"
(
  cd "$YAY_DIR"
  makepkg -si --noconfirm
)

# now you can run: yay -S --noconfirm min-browser zsh bat

# ─── 4) fzf integration ───────────────────────────────────────────────────────
if [[ ! -d "$USER_HOME/.fzf" ]]; then
  echo "→ Installing fzf"
  git clone --depth 1 https://github.com/junegunn/fzf.git "$USER_HOME/.fzf"
  yes | "$USER_HOME/.fzf/install" --all
else
  echo "→ fzf already installed"
fi

# ─── 5) Oh My Zsh ─────────────────────────────────────────────────────────────
if [[ ! -d "$USER_HOME/.oh-my-zsh" ]]; then
  echo "→ Installing Oh My Zsh"
  export RUNZSH=no CHSH=no
  sh -c 'curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh | sh'
else
  echo "→ Oh My Zsh already present"
fi

# ─── 6) Zsh plugins ───────────────────────────────────────────────────────────
ZSH_CUSTOM="$USER_HOME/.oh-my-zsh/custom"
declare -A ZSH_PLUGINS=(
  [zsh-autosuggestions]="https://github.com/zsh-users/zsh-autosuggestions.git"
  [zsh-syntax-highlighting]="https://github.com/zsh-users/zsh-syntax-highlighting.git"
  [fzf-tab]="https://github.com/Aloxaf/fzf-tab.git"
)
for name in "${!ZSH_PLUGINS[@]}"; do
  dest="$ZSH_CUSTOM/plugins/$name"
  if [[ ! -d "$dest" ]]; then
    echo "→ Installing plugin: $name"
    git clone "${ZSH_PLUGINS[$name]}" "$dest"
  else
    echo "→ Plugin $name already installed"
  fi
done

# ─── 7) Enable plugins in ~/.zshrc ───────────────────────────────────────────
ZSHRC="$USER_HOME/.zshrc"
if [[ -f "$ZSHRC" ]]; then
  if grep -q '^plugins=' "$ZSHRC"; then
    sed -i -E \
      "s|^plugins=\(.*\)|plugins=(git zsh-autosuggestions zsh-syntax-highlighting fzf-tab)|" \
      "$ZSHRC"
    echo "→ Updated plugins line in $ZSHRC"
  else
    echo "plugins=(git zsh-autosuggestions zsh-syntax-highlighting fzf-tab)" >> "$ZSHRC"
    echo "→ Added plugins line to $ZSHRC"
  fi
else
  echo "→ No ~/.zshrc found; creating a minimal one"
  cat << 'EOF' > "$ZSHRC"
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"
plugins=(git zsh-autosuggestions zsh-syntax-highlighting fzf-tab)
source $ZSH/oh-my-zsh.sh
EOF
fi

# ─── 8) Bootstrap your dotfiles ───────────────────────────────────────────────
if [[ -d "$USER_HOME/.dotfiles" ]]; then
  DOTDIR="$USER_HOME/.dotfiles"
elif [[ -d "$USER_HOME/dotfiles" ]]; then
  DOTDIR="$USER_HOME/dotfiles"
else
  GIT_DOTFILES_REPO="https://github.com/YOURUSERNAME/dotfiles.git"
  echo "→ No local dotfiles; cloning from $GIT_DOTFILES_REPO"
  git clone "$GIT_DOTFILES_REPO" "$USER_HOME/.dotfiles"
  DOTDIR="$USER_HOME/.dotfiles"
fi

if [[ -x "$DOTDIR/install" ]]; then
  echo "→ Running your dotfiles installer"
  "$DOTDIR/install"
else
  echo "→ Making installer executable and running it"
  chmod +x "$DOTDIR/install"
  "$DOTDIR/install"
fi

# ─── All done ────────────────────────────────────────────────────────────────
echo
echo "✔ Setup complete!"
echo "→ Don’t forget to install the system packages listed above,"
echo "   then log out and log back in (or run 'exec zsh') to start using Zsh + plugins."
